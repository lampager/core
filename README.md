<p align="center">
<img width="280" alt="lampager" src="https://user-images.githubusercontent.com/1351893/31754281-a36010cc-b4d1-11e7-8371-851f5faa3785.png">
</p>
<p align="center">
<a href="https://travis-ci.org/lampager/lampager"><img src="https://travis-ci.org/lampager/lampager.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/github/lampager/lampager?branch=master"><img src="https://coveralls.io/repos/github/lampager/lampager/badge.svg?branch=master" alt="Coverage Status"></a>
<a href="https://scrutinizer-ci.com/g/lampager/lampager/?branch=master"><img src="https://scrutinizer-ci.com/g/lampager/lampager/badges/quality-score.png?b=master" alt="Scrutinizer Code Quality"></a>
</p>

# Lampager Core

The core package of Lampager

## Requirements

- PHP: ^5.6 || ^7.0

## Installing

```bash
composer require lampager/lampager:^0.1.0
```

## Usage

Basically you don't need to directly use this package.
For example, if you uses Laravel, install [lampager/lampager-laravel](https://github.com/lampager/lampager-laravel).

However, you can use manually like this:

```php
use Lampager\Paginator;
use Lampager\ArrayProcessor;

$cursor = [
    'id' => 3,
    'created_at' => '2017-01-10 00:00:00',
    'updated_at' => '2017-01-20 00:00:00',
];

$query = (new Paginator())
    ->forward()
    ->limit(5)
    ->orderByDesc('updated_at') // ORDER BY `updated_at` DESC, `created_at` DESC, `id` DESC
    ->orderByDesc('created_at')
    ->orderByDesc('id')
    ->seekable()
    ->configure($cursor);

$rows = run_your_query_using_PDO($query); // Note: SQLite3 driver example is bundled in the tests/StubPaginator.php. Please refer to that.

$result = (new ArrayProcessor())->process($query, $rows);
```

It will run the optimized query.


```sql
(

    SELECT * FROM `posts`
    WHERE `user_id` = 1
    AND (
        `updated_at` = '2017-01-20 00:00:00' AND `created_at` = '2017-01-10 00:00:00' AND `id` > 3
        OR
        `updated_at` = '2017-01-20 00:00:00' AND `created_at` > '2017-01-10 00:00:00'
        OR
        `updated_at` > '2017-01-20 00:00:00'
    )
    ORDER BY `updated_at` ASC, `created_at` ASC, `id` ASC
    LIMIT 1

) UNION ALL (

    SELECT * FROM `posts`
    WHERE `user_id` = 1
    AND (
        `updated_at` = '2017-01-20 00:00:00' AND `created_at` = '2017-01-10 00:00:00' AND `id` <= 3
        OR
        `updated_at` = '2017-01-20 00:00:00' AND `created_at` < '2017-01-10 00:00:00'
        OR
        `updated_at` < '2017-01-20 00:00:00'
    )
    ORDER BY `updated_at` DESC, `created_at` DESC, `id` DESC
    LIMIT 4

)
```

And you'll get


```json
{
  "records": [
    {
      "id": 3,
      "user_id": 1,
      "text": "foo",
      "created_at": "2017-01-10 00:00:00",
      "updated_at": "2017-01-20 00:00:00"
    },
    {
      "id": 5,
      "user_id": 1,
      "text": "bar",
      "created_at": "2017-01-05 00:00:00",
      "updated_at": "2017-01-20 00:00:00"
    },
    {
      "id": 4,
      "user_id": 1,
      "text": "baz",
      "created_at": "2017-01-05 00:00:00",
      "updated_at": "2017-01-20 00:00:00"
    },
    {
      "id": 2,
      "user_id": 1,
      "text": "qux",
      "created_at": "2017-01-17 00:00:00",
      "updated_at": "2017-01-18 00:00:00"
    },
    {
      "id": 1,
      "user_id": 1,
      "text": "quux",
      "created_at": "2017-01-16 00:00:00",
      "updated_at": "2017-01-18 00:00:00"
    }
  ],
  "meta": {
    "previous_cursor": null,
    "next_cursor": {
      "id": 6,
      "created_at": "2017-01-14 00:00:00",
      "updated_at": "2017-01-18 00:00:00"
    }
  }
}
```

## Classes

| Name | Type | Parent Class | Description |
|:---|:---|:---|:---|
| Lampager\\**`Paginator`** | Class | | Fluent factory for building Query |
| Lampager\\**`AbstractProcessor`** | Abstract Class | | Receive fetched records and format them |
| Lampager\\`ArrayProcessor` | Class | Lampager\\`AbstractProcessor` | Simple Processor implementation for pure PDO |
| Lampager\\Query\\`Query` | Class | | SQL configuration container generated by Paginator |
| Lampager\\Query\\... | Class | | Children components of Query |
| Lampager\\Contracts\\`Formatter` | Interface | | Formatter interface pluggable to Processor |
| Lampager\\Concerns\\`HasProcessor` | Trait | | Helper for extended Paginator providing convenient accessibility to Processor |

## API

### Paginator::orderBy()<br>Paginator::orderByDesc()<br>Paginator::clearOrderBy()

Add or clear cursor parameter name for `ORDER BY` statement.  
At least one parameter required.

```php
Paginator::orderBy(string $column, string $direction = 'asc'): $this
Paginator::orderByDesc(string $column): $this
Paginator::clearOrderBy(): $this
```

**IMPORTANT**: The last key MUST be the primary key.

e.g. `$paginator->orderBy('updated_at')->orderBy('id')`

#### Arguments

- **`(string)`** __*$column*__<br> Table column name.
- **`(string)`** __*$direction*__<br> `"asc"` or `"desc"`.

### Paginator::limit()

Define the pagination limit.

```php
Paginator::limit(int $limit): $this
```

#### Arguments

- **`(int)`** __*$limit*__<br> Positive integer.

### Paginator::forward()<br>Paginator::backward()

Define the pagination direction.

```php
Paginator::forward(): $this
Paginator::backward(): $this
```

#### Forward (Default)

```
    ===============>
[2] [ 3, 4, 5, 6, 7] [8]
 |    |               └ next cursor
 |    └ current cursor
 └ previous cursor
```

```
    ===============>
[8] [ 7, 6, 5, 4, 3] [2]
 |    |               └ next cursor
 |    └ current cursor
 └ previous cursor
```

#### Backward

```
    <===============
[2] [ 3, 4, 5, 6, 7] [8]
 |                |   └ next cursor
 |                └ current cursor
 └ previous cursor
```

```
    <===============
[8] [ 7, 6, 5, 4, 3] [2]
 |                |   └ next cursor
 |                └ current cursor
 └ previous cursor
```

**IMPORTANT**: You need **previous** cursor to retrieve more results.

### Paginator::inclusive()<br>Paginator::exclusive()

```php
Paginator::inclusive(): $this
Paginator::exclusive(): $this
```

Change the behavior of handling cursor.

#### Inclusive (Default)

Current cursor is included in the current page.

```
    ===============>
[2] [ 3, 4, 5, 6, 7] [8]
 |    |               └ next cursor
 |    └ current cursor
 └ previous cursor
```

```
    <===============
[2] [ 3, 4, 5, 6, 7] [8]
 |                |   └ next cursor
 |                └ current cursor
 └ previous cursor
```

#### Exclusive

Current cursor is not included in the current page.

```
    ===============>
[2] [ 3, 4, 5, 6, 7] [8]
 |                └ next cursor
 └ current cursor
```

```
    <===============
[2] [ 3, 4, 5, 6, 7] [8]
      |               |
      |               └ current cursor
      └ previous cursor
```

### Paginator::unseekable()<br>Paginator::seekable()

```php
Paginator::unseekable(): $this
Paginator::seekable(): $this
```

Define that the pagination result should contain both of the next cursor and the previous cursor.

- `unseekable()` always requires simple one `SELECT` query. (Default)
- `seekable()` may require `SELECT ... UNION ALL SELECT ...` query when the cursor parameters are not empty.

#### Unseekable (Default)

```
    ===============>
[?] [ 3, 4, 5, 6, 7] [8]
      |               └ next cursor
      └ current cursor

```

#### Seekable

```
    ===============>
[2] [ 3, 4, 5, 6, 7] [8]
 |    |               └ next cursor
 |    └ current cursor
 └ previous cursor
```

#### Always when the current cursor parameters are empty

```
===============>
[ 1, 2, 3, 4, 5] [6]
                  └ next cursor
```

### Paginator::configure()

Generate Query corresponding to the current cursor.

```php
Paginator::configure(array $cursor = []): Query
```

#### Arguments

- **`(array)`** __*$cursor*__<br> Associative array that contains `$column => $value`. It must be **all-or-nothing**.
  - For initial page, omit this parameter or pass empty array.
  - For subsequent pages, pass all parameters. Partial parameters are not allowd.

### AbstractProcessor::process()

Receive a pair of Query and fetched rows to analyze and format them.

```php
AbstractProcessor::process(Query $query, mixed $rows): mixed
```

#### Arguments

- **`(Query)`** __*$query*__
- **`(mixed)`** __*$rows*__<br> Fetched records from database. Typically it should be an array or a Traversable.

#### Return Value

**`(mixed)`**

By default, the following simple array will be returned.

```php
[
    'records' => [
        ['id' => 3, 'name' => 'foo'],
        ['id' => 4, 'name' => 'bar'],
        ...,
        ['id' => 7, 'name' => 'baz'],
    ]
    'meta' => [
        'next_cursor' => ['id' => 8, 'name' => 'qux'],
        'previous_cursor' => ['id' => 2, 'name' => 'quux'],
    ],
]
```

Note that

- `next_cursor`/`previous_cursor` will be `null` when there are no more results for the corresponding direction.
- Either of `next_cursor`/`previous_cursor` will be undefined when `$cursor` is empty or `seekable()` is not be enabled.

### AbstractProcessor::useFormatter()<br>AbstractProcessor::restoreFormatter()

Override or restore the formatter for the pagination result.

```php
AbstractProcessor::useFormatter(Formatter|callable $formatter): $this
AbstractProcessor::restoreFormatter(): $this
```

#### Callable Formatter Example

```php
<?php

use Lampager\Query\Query;
use Lampager\ArrayProcessor;

$formatter = function ($rows, array $meta, Query $query) {
    $newMeta = [];

    foreach (['previous', 'next'] as $direction) {
        if (array_key_exists("{$direction}_cursor", $meta)) {
            $newMeta["{$direction}_id"] = (int)$meta["{$direction}_cursor"]['id'];
            $newMeta["{$direction}_user_id"] = (int)$meta["{$direction}_cursor"]['user_id'];
        }
    }

    return [
        'posts' => $rows,
        'meta' => $newMeta,
    ];
};

$result = (new ArrayProcessor())->useFormatter($formatter)->process($query, $rows);
```

#### Class Formatter Example

```php
<?php

use Lampager\Query\Query;
use Lampager\ArrayProcessor;
use Lampager\Contracts\Formatter;

class PostFormatter implements Formatter
{
    public function format($rows, array $meta, Query $query)
    {
        $newMeta = [];

        foreach (['previous', 'next'] as $direction) {
            if (array_key_exists("{$direction}_cursor", $meta)) {
                $newMeta["{$direction}_id"] = (int)$meta["{$direction}_cursor"]['id'];
                $newMeta["{$direction}_user_id"] = (int)$meta["{$direction}_cursor"]['user_id'];
            }
        }

        return [
            'posts' => $rows,
            'meta' => $newMeta,
        ];
    }
}

$result = (new ArrayProcessor())->useFormatter(PostFormatter::class)->process($query, $rows);
```

### AbstractProcessor::setDefaultFormatter()<br>AbstractProcessor::restoreDefaultFormatter()

Globally override or restore the formatter.

```php
static AbstractProcessor::setDefaultFormatter(Formatter|callable $formatter): void
static AbstractProcessor::restoreDefaultFormatter(): void
```

#### Example (Laravel)

```php
<?php

use Illuminate\Database\Eloquent\Builder;
use Lampager\Query\Query;
use Lampager\Laravel\Processor as IlluminateProcessor;

IlluminateProcessor::setDefaultFormatter(function ($rows, array $meta, Query $query) {

   // Note:
   //    $builder is provided from extended Paginator.
   //    For example, lampager/lampager-laravel provides QueryBuilder, EloquentBuilder or Relation.
   $builder = $query->builder();

   switch ($builder instanceof Builder ? $builder->getModel() : null) {

       case Post::class:
           return (new PostFormatter())->format($rows, $meta, $query);

       case Comment::class:
          return (new CommentFormatter())->format($rows, $meta, $query);

       default:
           return [
               'records' => $rows,
               'meta' => $meta,
           ];
   }
});

$posts = Post::lampage()->orderBy('created_at')->orderBy('id')->paginate();
$comments = Comment::lampage()->orderBy('created_at')->orderBy('id')->paginate();
```
